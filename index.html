<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מזג אוויר</title>
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link id="manifest-link" rel="manifest" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            min-height: 100%;
            background: #1d4ed8;
            overscroll-behavior-y: none;
        }

        body {
            font-family: 'Rubik', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .glass-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .glass-input:focus { outline: none; background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        #app-container {
            min-height: 100dvh;
            transition: background 0.8s ease-in-out;
            padding-top: calc(1rem + env(safe-area-inset-top));
            padding-bottom: calc(5.5rem + env(safe-area-inset-bottom));
        }

        #bottom-nav {
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
        }

        .suggestions {
            position: absolute;
            inset-inline: 0;
            top: calc(100% + 8px);
            z-index: 30;
            max-height: 220px;
            overflow-y: auto;
        }

        .swipe-dot { width: 8px; height: 8px; border-radius: 9999px; background: rgba(255,255,255,0.45); }
        .swipe-dot.active { width: 18px; background: white; }

        .city-item-content { transition: transform 0.2s ease; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white overflow-x-hidden">
<div id="app-container" class="w-full bg-gradient-to-br from-blue-500 to-blue-300">
    <div class="w-full max-w-lg mx-auto px-4 sm:px-6 md:px-8">

        <section id="weather-screen" class="screen active space-y-5">
            <div class="flex items-center gap-3">
                <form id="search-form" class="flex-1 relative">
                    <input type="text" id="search-input" placeholder="חפש עיר..." autocomplete="off" class="w-full glass-input rounded-2xl py-3 px-12 text-lg shadow-sm">
                    <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/80"></i>
                    <button type="submit" class="hidden"></button>
                    <div id="search-suggestions" class="suggestions glass-panel rounded-2xl hidden"></div>
                </form>
                <button id="location-btn" class="glass-panel p-3 rounded-2xl active:scale-95" aria-label="המיקום שלי">
                    <i data-lucide="navigation" class="w-6 h-6 text-white"></i>
                </button>
            </div>

            <div id="status-message" class="hidden text-center bg-red-500/50 backdrop-blur-sm text-white p-3 rounded-xl text-sm"></div>

            <div id="city-swiper" class="space-y-4 touch-pan-y">
                <div id="main-card" class="glass-panel rounded-3xl p-6 sm:p-8 flex flex-col items-center relative overflow-hidden opacity-0 transition-opacity duration-500">
                    <h1 id="city-name" class="text-3xl sm:text-4xl font-bold mb-1 text-center">טוען...</h1>
                    <p id="date-display" class="text-white/80 text-sm sm:text-base mb-6">--</p>

                    <div class="flex items-center justify-center gap-6 mb-6">
                        <div id="main-icon-container"><i data-lucide="sun" class="w-20 h-20 sm:w-24 sm:h-24"></i></div>
                        <div class="flex flex-col">
                            <div class="flex items-start">
                                <span id="current-temp" class="text-6xl sm:text-7xl font-bold tracking-tighter">--</span>
                                <span class="text-2xl sm:text-3xl font-medium mt-2">°</span>
                            </div>
                            <span id="weather-desc" class="text-xl font-medium mt-1">--</span>
                        </div>
                    </div>

                    <div class="w-full flex justify-between items-center border-t border-white/20 pt-4 px-2">
                        <div class="flex items-center gap-2"><i data-lucide="thermometer" class="w-5 h-5 opacity-80"></i><span class="text-sm">מרגיש כמו <strong id="feels-like" class="text-base">--°</strong></span></div>
                        <div class="flex items-center gap-3 text-sm">
                            <span class="flex items-center gap-1"><i data-lucide="arrow-up" class="w-4 h-4 text-red-200"></i><span id="temp-max">--°</span></span>
                            <span class="flex items-center gap-1"><i data-lucide="arrow-down" class="w-4 h-4 text-blue-200"></i><span id="temp-min">--°</span></span>
                        </div>
                    </div>

                    <div class="w-full grid grid-cols-3 gap-3 text-center mt-4">
                        <div class="glass-panel rounded-xl p-2"><i data-lucide="droplets" class="w-4 h-4 mx-auto mb-1"></i><p id="humidity" class="text-sm font-semibold">--%</p><p class="text-xs opacity-70">לחות</p></div>
                        <div class="glass-panel rounded-xl p-2"><i data-lucide="wind" class="w-4 h-4 mx-auto mb-1"></i><p id="wind-speed" class="text-sm font-semibold">--</p><p class="text-xs opacity-70">רוח</p></div>
                        <div class="glass-panel rounded-xl p-2"><i data-lucide="cloud-rain" class="w-4 h-4 mx-auto mb-1"></i><p id="precipitation" class="text-sm font-semibold">--</p><p class="text-xs opacity-70">משקעים</p></div>
                    </div>
                </div>

                <div id="hourly-card" class="glass-panel rounded-3xl p-5 opacity-0 transition-opacity duration-500 delay-100">
                    <h2 class="text-sm font-semibold mb-4 opacity-90 flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> תחזית שעתית</h2>
                    <div id="hourly-container" class="flex gap-4 overflow-x-auto no-scrollbar pb-2"></div>
                </div>

                <div id="daily-card" class="glass-panel rounded-3xl p-5 opacity-0 transition-opacity duration-500 delay-200">
                    <h2 class="text-sm font-semibold mb-4 opacity-90 flex items-center gap-2"><i data-lucide="calendar-days" class="w-4 h-4"></i> תחזית ל-7 ימים</h2>
                    <div id="daily-container" class="flex flex-col gap-3"></div>
                </div>
            </div>

            <div id="city-indicators" class="flex justify-center items-center gap-2"></div>
        </section>

        <section id="cities-screen" class="screen space-y-4">
            <h2 class="text-2xl font-bold">הערים שלי</h2>
            <p class="text-sm opacity-80">חפש והוסף ערים. החלקה שמאלה על עיר חושפת מחיקה.</p>

            <form id="city-manager-form" class="relative">
                <input type="text" id="city-manager-input" placeholder="הוסף עיר לרשימה..." autocomplete="off" class="w-full glass-input rounded-2xl py-3 px-12 text-lg shadow-sm">
                <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/80"></i>
                <div id="city-manager-suggestions" class="suggestions glass-panel rounded-2xl hidden"></div>
            </form>

            <div id="saved-cities-list" class="space-y-3"></div>
        </section>

        <section id="settings-screen" class="screen space-y-4">
            <h2 class="text-2xl font-bold">הגדרות</h2>
            <div class="glass-panel rounded-3xl p-5 space-y-4">
                <label class="flex justify-between items-center">
                    <span>שמירת ערים מקומית</span>
                    <span class="text-sm bg-green-500/70 px-3 py-1 rounded-full">פעיל</span>
                </label>
                <p class="text-sm opacity-80">הערים נשמרות על המכשיר שלך בלבד באמצעות LocalStorage.</p>
            </div>
        </section>
    </div>

    <nav id="bottom-nav" class="fixed bottom-0 inset-x-0 z-40">
        <div class="mx-auto max-w-lg px-4 sm:px-6 md:px-8">
            <div class="glass-panel rounded-2xl p-2 grid grid-cols-3 gap-2">
                <button class="nav-btn bg-white/20 rounded-xl py-2" data-screen="weather-screen"><i data-lucide="cloud-sun" class="w-5 h-5 mx-auto"></i><span class="text-xs">מזג אוויר</span></button>
                <button class="nav-btn rounded-xl py-2" data-screen="cities-screen"><i data-lucide="map-pin" class="w-5 h-5 mx-auto"></i><span class="text-xs">ערים</span></button>
                <button class="nav-btn rounded-xl py-2" data-screen="settings-screen"><i data-lucide="settings" class="w-5 h-5 mx-auto"></i><span class="text-xs">הגדרות</span></button>
            </div>
        </div>
    </nav>
</div>

<script>
function setupPWA() {
    const manifest = {
        name: 'תחזית מזג אוויר', short_name: 'מזג אוויר', start_url: '.', display: 'standalone',
        background_color: '#3b82f6', theme_color: '#3b82f6', description: 'אפליקציית מזג אוויר מתקדמת בישראל',
        icons: [{ src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='4'/><path d='M12 2v2'/><path d='M12 20v2'/><path d='m4.93 4.93 1.41 1.41'/><path d='m17.66 17.66 1.41 1.41'/><path d='M2 12h2'/><path d='M20 12h2'/><path d='m6.34 17.66-1.41 1.41'/><path d='m19.07 4.93-1.41 1.41'/></svg>", sizes: '192x192', type: 'image/svg+xml' }]
    };
    document.getElementById('manifest-link').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], { type: 'application/json' }));

    if ('serviceWorker' in navigator) {
        const swCode = `self.addEventListener('install',()=>self.skipWaiting());self.addEventListener('activate',()=>self.clients.claim());self.addEventListener('fetch',(e)=>e.respondWith(fetch(e.request).catch(()=>new Response('offline'))));`;
        navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], { type: 'application/javascript' })));
    }
}

const weatherCodes = {
    0:{desc:'בהיר',icon:'sun'},1:{desc:'מעונן חלקית',icon:'cloud-sun'},2:{desc:'מעונן חלקית',icon:'cloud'},3:{desc:'מעונן',icon:'cloud'},45:{desc:'ערפל',icon:'cloud-fog'},48:{desc:'ערפל קופא',icon:'cloud-fog'},51:{desc:'טפטוף קל',icon:'cloud-drizzle'},53:{desc:'טפטוף',icon:'cloud-drizzle'},55:{desc:'טפטוף כבד',icon:'cloud-drizzle'},56:{desc:'טפטוף קופא קל',icon:'cloud-drizzle'},57:{desc:'טפטוף קופא כבד',icon:'cloud-drizzle'},61:{desc:'גשם קל',icon:'cloud-rain'},63:{desc:'גשם',icon:'cloud-rain'},65:{desc:'גשם כבד',icon:'cloud-rain'},66:{desc:'גשם קופא קל',icon:'cloud-snow'},67:{desc:'גשם קופא כבד',icon:'cloud-snow'},71:{desc:'שלג קל',icon:'cloud-snow'},73:{desc:'שלג',icon:'cloud-snow'},75:{desc:'שלג כבד',icon:'cloud-snow'},77:{desc:'ברד דק',icon:'cloud-snow'},80:{desc:'ממטרי גשם קלים',icon:'cloud-rain'},81:{desc:'ממטרי גשם',icon:'cloud-rain'},82:{desc:'ממטרי גשם עזים',icon:'cloud-rain'},85:{desc:'ממטרי שלג קלים',icon:'cloud-snow'},86:{desc:'ממטרי שלג כבדים',icon:'cloud-snow'},95:{desc:'סופת רעמים',icon:'cloud-lightning'},96:{desc:'סופת רעמים וברד',icon:'cloud-lightning'},99:{desc:'סופת רעמים וברד כבד',icon:'cloud-lightning'}
};

const storageKey = 'weather.savedCities.v1';
const elements = {
    container: document.getElementById('app-container'),
    form: document.getElementById('search-form'), input: document.getElementById('search-input'), suggestions: document.getElementById('search-suggestions'),
    managerForm: document.getElementById('city-manager-form'), managerInput: document.getElementById('city-manager-input'), managerSuggestions: document.getElementById('city-manager-suggestions'),
    locBtn: document.getElementById('location-btn'), status: document.getElementById('status-message'),
    mainCard: document.getElementById('main-card'), hourlyCard: document.getElementById('hourly-card'), dailyCard: document.getElementById('daily-card'),
    hourlyContainer: document.getElementById('hourly-container'), dailyContainer: document.getElementById('daily-container'), indicators: document.getElementById('city-indicators'), citiesList: document.getElementById('saved-cities-list')
};

const appState = { savedCities: [], activeCityIndex: 0, autocompleteTimer: null };

function showMessage(msg, isError = true) {
    elements.status.textContent = msg;
    elements.status.className = `text-center backdrop-blur-sm text-white p-3 rounded-xl text-sm mb-4 ${isError ? 'bg-red-500/50' : 'bg-blue-500/50'}`;
    elements.status.classList.remove('hidden');
    setTimeout(() => elements.status.classList.add('hidden'), 4000);
}

function persistCities() { localStorage.setItem(storageKey, JSON.stringify(appState.savedCities)); }
function loadCities() {
    try { appState.savedCities = JSON.parse(localStorage.getItem(storageKey) || '[]'); } catch { appState.savedCities = []; }
}

function toggleLoading(isLoading) {
    elements.locBtn.innerHTML = isLoading ? '<div class="loader"></div>' : '<i data-lucide="navigation" class="w-6 h-6 text-white"></i>';
    lucide.createIcons();
}

function updateBackground(weatherCode, isDay) {
    let classes = isDay ? 'from-blue-400 to-blue-200' : 'from-slate-900 to-indigo-900';
    if ([51,53,55,61,63,65,80,81,82,95,96,99].includes(weatherCode)) classes = isDay ? 'from-slate-600 to-blue-800' : 'from-slate-900 to-slate-700';
    else if ([2,3,45,48].includes(weatherCode)) classes = isDay ? 'from-gray-400 to-gray-300' : 'from-gray-800 to-gray-600';
    else if ([71,73,75,77,85,86].includes(weatherCode)) classes = isDay ? 'from-blue-200 to-white' : 'from-slate-800 to-blue-900';
    elements.container.className = `w-full bg-gradient-to-br transition-colors duration-1000 ${classes}`;
}

function getWeatherInfo(code, isDay) {
    const info = weatherCodes[code] || { desc:'לא ידוע', icon:'sun' };
    if (!isDay && code === 0) return { desc: info.desc, icon: 'moon' };
    if (!isDay && (code === 1 || code === 2)) return { desc: info.desc, icon: 'cloud-moon' };
    return info;
}

async function geocodeCities(query, count = 5) {
    const tryFetch = async (lang) => {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=${count}&language=${lang}&format=json`;
        const response = await fetch(url);
        if (!response.ok) return [];
        const data = await response.json();
        return data.results || [];
    };
    let results = await tryFetch('he');
    if (!results.length) results = await tryFetch('en');
    return results;
}

async function fetchWeather(lat, lon, cityName) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
    const response = await fetch(url);
    if (!response.ok) throw new Error('שגיאה בקבלת נתוני מזג האוויר');
    const data = await response.json();
    renderWeather(data, cityName);
}

function renderWeather(data, cityName) {
    const current = data.current; const daily = data.daily; const hourly = data.hourly; const isDay = current.is_day === 1;
    updateBackground(current.weather_code, isDay);

    document.getElementById('city-name').textContent = cityName;
    document.getElementById('date-display').textContent = new Date().toLocaleDateString('he-IL', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    document.getElementById('current-temp').textContent = Math.round(current.temperature_2m);
    document.getElementById('feels-like').textContent = `${Math.round(current.apparent_temperature)}°`;
    document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
    document.getElementById('wind-speed').innerHTML = `${Math.round(current.wind_speed_10m)} <span class="text-xs font-normal">קמ"ש</span>`;
    document.getElementById('precipitation').innerHTML = `${current.precipitation} <span class="text-xs font-normal">מ"מ</span>`;
    document.getElementById('temp-max').textContent = `${Math.round(daily.temperature_2m_max[0])}°`;
    document.getElementById('temp-min').textContent = `${Math.round(daily.temperature_2m_min[0])}°`;

    const weatherInfo = getWeatherInfo(current.weather_code, isDay);
    document.getElementById('weather-desc').textContent = weatherInfo.desc;
    document.getElementById('main-icon-container').innerHTML = `<i data-lucide="${weatherInfo.icon}" class="w-20 h-20 sm:w-24 sm:h-24"></i>`;

    elements.hourlyContainer.innerHTML = '';
    let startIdx = hourly.time.findIndex(t => t >= current.time);
    if (startIdx === -1) startIdx = 0;
    for (let i = startIdx; i < Math.min(startIdx + 24, hourly.time.length); i++) {
        const hour = new Date(hourly.time[i]).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        const temp = Math.round(hourly.temperature_2m[i]);
        const hInfo = getWeatherInfo(hourly.weather_code[i], i < 18);
        elements.hourlyContainer.innerHTML += `<div class="flex-shrink-0 text-center p-3 rounded-xl bg-white/10 min-w-[70px]"><span class="text-xs opacity-80">${hour}</span><i data-lucide="${hInfo.icon}" class="w-6 h-6 mx-auto my-2"></i><span class="font-medium">${temp}°</span></div>`;
    }

    elements.dailyContainer.innerHTML = '';
    for (let i = 1; i < 7; i++) {
        if (!daily.time[i]) break;
        const dayName = new Date(daily.time[i]).toLocaleDateString('he-IL', { weekday:'long' });
        const dInfo = getWeatherInfo(daily.weather_code[i], true);
        elements.dailyContainer.innerHTML += `<div class="flex items-center justify-between py-2 border-b border-white/10 last:border-0"><span class="w-24 font-medium">${dayName}</span><div class="flex items-center gap-2 flex-1 justify-center"><i data-lucide="${dInfo.icon}" class="w-5 h-5 opacity-80"></i><span class="text-sm opacity-80 hidden sm:inline">${dInfo.desc}</span></div><div class="flex gap-4 w-24 justify-end"><span class="font-medium">${Math.round(daily.temperature_2m_max[i])}°</span><span class="opacity-70">${Math.round(daily.temperature_2m_min[i])}°</span></div></div>`;
    }

    lucide.createIcons();
    [elements.mainCard, elements.hourlyCard, elements.dailyCard].forEach(card => card.classList.add('opacity-100'));
}

function renderIndicators() {
    elements.indicators.innerHTML = appState.savedCities.map((_, idx) => `<span class="swipe-dot ${idx === appState.activeCityIndex ? 'active' : ''}"></span>`).join('');
}

function renderSavedCities() {
    elements.citiesList.innerHTML = '';
    if (!appState.savedCities.length) {
        elements.citiesList.innerHTML = '<div class="glass-panel rounded-2xl p-4 text-sm opacity-85">עדיין לא נוספו ערים.</div>';
        return;
    }

    appState.savedCities.forEach((city, idx) => {
        const item = document.createElement('div');
        item.className = 'relative overflow-hidden rounded-2xl';
        item.innerHTML = `<button class="absolute left-0 top-0 bottom-0 bg-red-500 px-4 text-white delete-city" data-id="${city.id}">מחק</button><div class="city-item-content glass-panel p-4 rounded-2xl flex items-center justify-between" data-index="${idx}"><div><p class="font-semibold">${city.name}</p><p class="text-xs opacity-75">${city.country || ''}</p></div><i data-lucide="chevron-left" class="w-5 h-5 opacity-70"></i></div>`;
        elements.citiesList.appendChild(item);

        const content = item.querySelector('.city-item-content');
        let startX = 0; let swiped = false;
        content.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; swiped = false; }, { passive: true });
        content.addEventListener('touchmove', (e) => {
            const dx = e.touches[0].clientX - startX;
            if (dx < -20) { content.style.transform = 'translateX(-68px)'; swiped = true; }
            if (dx > 12) content.style.transform = 'translateX(0)';
        }, { passive: true });
        content.addEventListener('touchend', () => { if (!swiped) content.style.transform = 'translateX(0)'; });
        content.addEventListener('click', async () => { appState.activeCityIndex = idx; await loadActiveCityWeather(); switchScreen('weather-screen'); });
    });

    document.querySelectorAll('.delete-city').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = btn.dataset.id;
        appState.savedCities = appState.savedCities.filter(city => city.id !== id);
        appState.activeCityIndex = Math.max(0, Math.min(appState.activeCityIndex, appState.savedCities.length - 1));
        persistCities();
        renderSavedCities();
        renderIndicators();
        if (appState.savedCities.length) loadActiveCityWeather();
    }));

    lucide.createIcons();
}

async function addCity(city) {
    const id = `${city.latitude},${city.longitude}`;
    const exists = appState.savedCities.find(c => c.id === id);
    if (!exists) appState.savedCities.push({ id, name: city.name, country: city.country || '', latitude: city.latitude, longitude: city.longitude });
    appState.activeCityIndex = appState.savedCities.findIndex(c => c.id === id);
    persistCities();
    renderSavedCities();
    renderIndicators();
    await loadActiveCityWeather();
}

async function loadActiveCityWeather() {
    const city = appState.savedCities[appState.activeCityIndex];
    if (!city) return;
    await fetchWeather(city.latitude, city.longitude, city.country ? `${city.name}, ${city.country}` : city.name);
    renderIndicators();
}

async function handleCitySearch(query, target = 'main') {
    if (!query.trim()) return;
    try {
        const results = await geocodeCities(query, 1);
        if (!results.length) throw new Error('לא מצאנו עיר כזאת. נסה שוב.');
        await addCity(results[0]);
        if (target === 'main') elements.input.value = '';
        if (target === 'manager') elements.managerInput.value = '';
    } catch (err) {
        showMessage(err.message);
    }
}

function renderAutocomplete(container, results, onPick) {
    if (!results.length) { container.classList.add('hidden'); container.innerHTML = ''; return; }
    container.innerHTML = results.map(city => `<button type="button" class="w-full text-right px-4 py-3 border-b border-white/10 last:border-0 hover:bg-white/10" data-id="${city.latitude},${city.longitude}">${city.name}${city.country ? `, ${city.country}` : ''}</button>`).join('');
    container.classList.remove('hidden');
    [...container.querySelectorAll('button')].forEach((btn, idx) => btn.addEventListener('click', () => onPick(results[idx])));
}

function attachAutocomplete(input, container) {
    input.addEventListener('input', () => {
        clearTimeout(appState.autocompleteTimer);
        const query = input.value.trim();
        if (query.length < 2) return renderAutocomplete(container, [], () => {});
        appState.autocompleteTimer = setTimeout(async () => {
            const results = await geocodeCities(query, 6);
            renderAutocomplete(container, results, async (city) => {
                await addCity(city);
                input.value = '';
                container.classList.add('hidden');
            });
        }, 250);
    });

    document.addEventListener('click', (e) => {
        if (!container.contains(e.target) && e.target !== input) container.classList.add('hidden');
    });
}

function setupWeatherSwipe() {
    const swiper = document.getElementById('city-swiper');
    let startX = 0; let startY = 0;
    swiper.addEventListener('touchstart', (e) => {
        if (e.target.closest('#hourly-container')) return;
        startX = e.touches[0].clientX; startY = e.touches[0].clientY;
    }, { passive: true });

    swiper.addEventListener('touchend', async (e) => {
        if (e.target.closest('#hourly-container')) return;
        const dx = (e.changedTouches[0].clientX - startX);
        const dy = Math.abs(e.changedTouches[0].clientY - startY);
        if (dy > 50 || Math.abs(dx) < 60 || appState.savedCities.length < 2) return;
        if (dx < 0) appState.activeCityIndex = Math.min(appState.savedCities.length - 1, appState.activeCityIndex + 1);
        else appState.activeCityIndex = Math.max(0, appState.activeCityIndex - 1);
        await loadActiveCityWeather();
    }, { passive: true });
}

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === screenId));
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('bg-white/20', btn.dataset.screen === screenId));
}

function getLocationWeather() {
    toggleLoading(true);
    if (!navigator.geolocation) { showMessage('הדפדפן שלך לא תומך באיתור מיקום'); toggleLoading(false); return; }

    navigator.geolocation.getCurrentPosition(async (position) => {
        try {
            const lat = position.coords.latitude; const lon = position.coords.longitude;
            const city = { name: 'המיקום שלי', country: '', latitude: lat, longitude: lon };
            await addCity(city);
        } catch (err) {
            showMessage('לא הצלחנו לאתר את המיקום שלך.');
        } finally {
            toggleLoading(false);
        }
    }, () => { toggleLoading(false); showMessage('אין הרשאת גישה למיקום. חפש לפי שם עיר.'); });
}

function setupEvents() {
    elements.form.addEventListener('submit', async (e) => { e.preventDefault(); await handleCitySearch(elements.input.value, 'main'); elements.input.blur(); });
    elements.managerForm.addEventListener('submit', async (e) => { e.preventDefault(); await handleCitySearch(elements.managerInput.value, 'manager'); elements.managerInput.blur(); });
    elements.locBtn.addEventListener('click', getLocationWeather);
    document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => switchScreen(btn.dataset.screen)));
    attachAutocomplete(elements.input, elements.suggestions);
    attachAutocomplete(elements.managerInput, elements.managerSuggestions);
    setupWeatherSwipe();
}

document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    setupPWA();
    setupEvents();
    loadCities();

    if (!appState.savedCities.length) {
        appState.savedCities = [{ id: '32.0853,34.7818', name: 'תל אביב-יפו', country: 'ישראל', latitude: 32.0853, longitude: 34.7818 }];
        persistCities();
    }

    renderSavedCities();
    renderIndicators();
    await loadActiveCityWeather();
});
</script>
</body>
</html>
