<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מזג אוויר</title>
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Link for dynamic PWA Manifest -->
    <link id="manifest-link" rel="manifest" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .glass-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .glass-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Hide scrollbar for horizontal scroll but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #app-container {
            transition: background 0.8s ease-in-out;
        }
    </style>
</head>
<body class="text-white min-h-screen m-0 p-0 overflow-x-hidden">

    <!-- Dynamic Background Container -->
    <div id="app-container" class="min-h-screen w-full bg-gradient-to-br from-blue-500 to-blue-300 p-4 sm:p-6 md:p-8 flex flex-col items-center">
        
        <div class="w-full max-w-lg mx-auto space-y-6">
            
            <!-- Header & Search -->
            <div class="flex items-center gap-3">
                <form id="search-form" class="flex-1 relative">
                    <input type="text" id="search-input" placeholder="חפש עיר..." autocomplete="off"
                        class="w-full glass-input rounded-2xl py-3 px-12 text-lg shadow-sm transition-all">
                    <i data-lucide="search" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-white/80"></i>
                    <button type="submit" class="hidden"></button>
                </form>
                <button id="location-btn" class="glass-panel p-3 rounded-2xl hover:bg-white/20 transition-colors active:scale-95 flex-shrink-0" aria-label="המיקום שלי">
                    <i data-lucide="navigation" class="w-6 h-6 text-white"></i>
                </button>
            </div>

            <!-- Error / Loading Message -->
            <div id="status-message" class="hidden text-center bg-red-500/50 backdrop-blur-sm text-white p-3 rounded-xl text-sm"></div>

            <!-- Main Weather Card -->
            <div id="main-card" class="glass-panel rounded-3xl p-6 sm:p-8 flex flex-col items-center relative overflow-hidden hidden opacity-0 transition-opacity duration-500">
                <h1 id="city-name" class="text-3xl sm:text-4xl font-bold mb-1 text-center drop-shadow-md">טוען...</h1>
                <p id="date-display" class="text-white/80 text-sm sm:text-base mb-6 drop-shadow-sm">--</p>

                <div class="flex items-center justify-center gap-6 mb-6">
                    <div id="main-icon-container" class="drop-shadow-lg">
                        <i data-lucide="sun" class="w-20 h-20 sm:w-24 sm:h-24"></i>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-start">
                            <span id="current-temp" class="text-6xl sm:text-7xl font-bold tracking-tighter drop-shadow-lg">--</span>
                            <span class="text-2xl sm:text-3xl font-medium mt-2">°</span>
                        </div>
                        <span id="weather-desc" class="text-xl font-medium mt-1 drop-shadow-md">--</span>
                    </div>
                </div>

                <!-- High/Low & Feels Like -->
                <div class="w-full flex justify-between items-center border-t border-white/20 pt-4 px-2">
                    <div class="flex items-center gap-2">
                        <i data-lucide="thermometer" class="w-5 h-5 opacity-80"></i>
                        <span class="text-sm">מרגיש כמו <strong id="feels-like" class="text-base">--°</strong></span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <span class="flex items-center gap-1"><i data-lucide="arrow-up" class="w-4 h-4 text-red-200"></i><span id="temp-max">--°</span></span>
                        <span class="flex items-center gap-1"><i data-lucide="arrow-down" class="w-4 h-4 text-blue-200"></i><span id="temp-min">--°</span></span>
                    </div>
                </div>

                <!-- Extra Details Grid -->
                <div class="w-full grid grid-cols-3 gap-4 mt-6 pt-4 border-t border-white/20">
                    <div class="flex flex-col items-center gap-1">
                        <i data-lucide="droplets" class="w-5 h-5 opacity-80"></i>
                        <span id="humidity" class="font-semibold text-lg">--%</span>
                        <span class="text-xs opacity-75">לחות</span>
                    </div>
                    <div class="flex flex-col items-center gap-1 border-x border-white/20">
                        <i data-lucide="wind" class="w-5 h-5 opacity-80"></i>
                        <span id="wind-speed" class="font-semibold text-lg">-- <span class="text-xs font-normal">קמ"ש</span></span>
                        <span class="text-xs opacity-75">רוח</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <i data-lucide="cloud-rain" class="w-5 h-5 opacity-80"></i>
                        <span id="precipitation" class="font-semibold text-lg">-- <span class="text-xs font-normal">מ"מ</span></span>
                        <span class="text-xs opacity-75">משקעים</span>
                    </div>
                </div>
            </div>

            <!-- Hourly Forecast -->
            <div id="hourly-card" class="glass-panel rounded-3xl p-5 hidden opacity-0 transition-opacity duration-500 delay-100">
                <h2 class="text-sm font-semibold mb-4 opacity-90 flex items-center gap-2">
                    <i data-lucide="clock" class="w-4 h-4"></i> תחזית שעתית
                </h2>
                <div id="hourly-container" class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                    <!-- Hourly items will be injected here -->
                </div>
            </div>

            <!-- Daily Forecast -->
            <div id="daily-card" class="glass-panel rounded-3xl p-5 hidden opacity-0 transition-opacity duration-500 delay-200">
                <h2 class="text-sm font-semibold mb-4 opacity-90 flex items-center gap-2">
                    <i data-lucide="calendar-days" class="w-4 h-4"></i> תחזית ל-7 ימים
                </h2>
                <div id="daily-container" class="flex flex-col gap-3">
                    <!-- Daily items will be injected here -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- PWA (PAW) Setup via Inline Blob ---
        function setupPWA() {
            // 1. Generate Manifest dynamically
            const manifest = {
                "name": "תחזית מזג אוויר",
                "short_name": "מזג אוויר",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#3b82f6",
                "theme_color": "#3b82f6",
                "description": "אפליקציית מזג אוויר מתקדמת בישראל",
                "icons": [
                    {
                        "src": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='4'/><path d='M12 2v2'/><path d='M12 20v2'/><path d='m4.93 4.93 1.41 1.41'/><path d='m17.66 17.66 1.41 1.41'/><path d='M2 12h2'/><path d='M20 12h2'/><path d='m6.34 17.66-1.41 1.41'/><path d='m19.07 4.93-1.41 1.41'/></svg>",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='4'/><path d='M12 2v2'/><path d='M12 20v2'/><path d='m4.93 4.93 1.41 1.41'/><path d='m17.66 17.66 1.41 1.41'/><path d='M2 12h2'/><path d='M20 12h2'/><path d='m6.34 17.66-1.41 1.41'/><path d='m19.07 4.93-1.41 1.41'/></svg>",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            document.getElementById('manifest-link').href = URL.createObjectURL(manifestBlob);

            // 2. Register inline Service Worker
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', (e) => {
                        self.clients.claim();
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            fetch(e.request).catch(() => new Response('Network error. Offline mode not fully cached yet.'))
                        );
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('PWA Service Worker Registered'))
                    .catch(err => console.log('SW Registration failed: ', err));
            }
        }

        // --- Weather Logic ---

        // WMO Weather interpretation codes
        const weatherCodes = {
            0: { desc: 'בהיר', icon: 'sun' },
            1: { desc: 'מעונן חלקית', icon: 'cloud-sun' },
            2: { desc: 'מעונן חלקית', icon: 'cloud' },
            3: { desc: 'מעונן', icon: 'cloud' },
            45: { desc: 'ערפל', icon: 'cloud-fog' },
            48: { desc: 'ערפל קופא', icon: 'cloud-fog' },
            51: { desc: 'טפטוף קל', icon: 'cloud-drizzle' },
            53: { desc: 'טפטוף', icon: 'cloud-drizzle' },
            55: { desc: 'טפטוף כבד', icon: 'cloud-drizzle' },
            56: { desc: 'טפטוף קופא קל', icon: 'cloud-drizzle' },
            57: { desc: 'טפטוף קופא כבד', icon: 'cloud-drizzle' },
            61: { desc: 'גשם קל', icon: 'cloud-rain' },
            63: { desc: 'גשם', icon: 'cloud-rain' },
            65: { desc: 'גשם כבד', icon: 'cloud-rain' },
            66: { desc: 'גשם קופא קל', icon: 'cloud-snow' },
            67: { desc: 'גשם קופא כבד', icon: 'cloud-snow' },
            71: { desc: 'שלג קל', icon: 'cloud-snow' },
            73: { desc: 'שלג', icon: 'cloud-snow' },
            75: { desc: 'שלג כבד', icon: 'cloud-snow' },
            77: { desc: 'ברד דק', icon: 'cloud-snow' },
            80: { desc: 'ממטרי גשם קלים', icon: 'cloud-rain' },
            81: { desc: 'ממטרי גשם', icon: 'cloud-rain' },
            82: { desc: 'ממטרי גשם עזים', icon: 'cloud-rain' },
            85: { desc: 'ממטרי שלג קלים', icon: 'cloud-snow' },
            86: { desc: 'ממטרי שלג כבדים', icon: 'cloud-snow' },
            95: { desc: 'סופת רעמים', icon: 'cloud-lightning' },
            96: { desc: 'סופת רעמים וברד', icon: 'cloud-lightning' },
            99: { desc: 'סופת רעמים וברד כבד', icon: 'cloud-lightning' },
        };

        const elements = {
            container: document.getElementById('app-container'),
            form: document.getElementById('search-form'),
            input: document.getElementById('search-input'),
            locBtn: document.getElementById('location-btn'),
            status: document.getElementById('status-message'),
            mainCard: document.getElementById('main-card'),
            hourlyCard: document.getElementById('hourly-card'),
            dailyCard: document.getElementById('daily-card'),
        };

        function showMessage(msg, isError = true) {
            elements.status.textContent = msg;
            elements.status.className = `text-center backdrop-blur-sm text-white p-3 rounded-xl text-sm mb-4 ${isError ? 'bg-red-500/50' : 'bg-blue-500/50'}`;
            elements.status.classList.remove('hidden');
            setTimeout(() => elements.status.classList.add('hidden'), 4000);
        }

        function toggleLoading(isLoading) {
            if (isLoading) {
                elements.locBtn.innerHTML = '<div class="loader"></div>';
            } else {
                elements.locBtn.innerHTML = '<i data-lucide="navigation" class="w-6 h-6 text-white"></i>';
                lucide.createIcons();
            }
        }

        function updateBackground(weatherCode, isDay) {
            let classes = '';
            
            // Default background fallback
            classes = isDay ? 'from-blue-400 to-blue-200' : 'from-slate-900 to-indigo-900';

            // Rain / Drizzle / Storm
            if ([51,53,55,61,63,65,80,81,82,95,96,99].includes(weatherCode)) {
                classes = isDay ? 'from-slate-600 to-blue-800' : 'from-slate-900 to-slate-700';
            }
            // Cloudy / Fog
            else if ([2,3,45,48].includes(weatherCode)) {
                classes = isDay ? 'from-gray-400 to-gray-300' : 'from-gray-800 to-gray-600';
            }
            // Snow
            else if ([71,73,75,77,85,86].includes(weatherCode)) {
                classes = isDay ? 'from-blue-200 to-white' : 'from-slate-800 to-blue-900';
            }

            elements.container.className = `min-h-screen w-full p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gradient-to-br transition-colors duration-1000 ${classes}`;
        }

        function getWeatherInfo(code, isDay) {
            let info = weatherCodes[code] || { desc: 'לא ידוע', icon: 'sun' };
            let iconStr = info.icon;
            
            // Adjust icon for night if it's clear or partly cloudy
            if (!isDay) {
                if (code === 0) iconStr = 'moon';
                if (code === 1 || code === 2) iconStr = 'cloud-moon';
            }
            return { desc: info.desc, icon: iconStr };
        }

        async function fetchWeather(lat, lon, cityName) {
            try {
                // Fetch current, hourly, and daily data from Open-Meteo
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("שגיאה בקבלת נתוני מזג האוויר");
                const data = await response.json();
                
                renderWeather(data, cityName);
            } catch (err) {
                showMessage(err.message);
            }
        }

        function renderWeather(data, cityName) {
            const current = data.current;
            const daily = data.daily;
            const hourly = data.hourly;
            const isDay = current.is_day === 1;

            // Update Background
            updateBackground(current.weather_code, isDay);

            // 1. Update Main Card
            document.getElementById('city-name').textContent = cityName;
            
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').textContent = now.toLocaleDateString('he-IL', dateOptions);

            document.getElementById('current-temp').textContent = Math.round(current.temperature_2m);
            document.getElementById('feels-like').textContent = `${Math.round(current.apparent_temperature)}°`;
            document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
            document.getElementById('wind-speed').innerHTML = `${Math.round(current.wind_speed_10m)} <span class="text-xs font-normal">קמ"ש</span>`;
            document.getElementById('precipitation').innerHTML = `${current.precipitation} <span class="text-xs font-normal">מ"מ</span>`;
            
            document.getElementById('temp-max').textContent = `${Math.round(daily.temperature_2m_max[0])}°`;
            document.getElementById('temp-min').textContent = `${Math.round(daily.temperature_2m_min[0])}°`;

            const weatherInfo = getWeatherInfo(current.weather_code, isDay);
            document.getElementById('weather-desc').textContent = weatherInfo.desc;
            document.getElementById('main-icon-container').innerHTML = `<i data-lucide="${weatherInfo.icon}" class="w-20 h-20 sm:w-24 sm:h-24"></i>`;

            // 2. Update Hourly Forecast (next 24 hours)
            const hourlyContainer = document.getElementById('hourly-container');
            hourlyContainer.innerHTML = '';
            
            // Find current hour index
            const currentHourStr = current.time.substring(0, 14) + "00"; // e.g. "2023-10-25T14:00"
            let startIdx = hourly.time.findIndex(t => t >= current.time);
            if(startIdx === -1) startIdx = 0;

            for (let i = startIdx; i < startIdx + 24; i += 2) { // Every 2 hours
                if (!hourly.time[i]) break;
                
                const timeStr = new Date(hourly.time[i]).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                const temp = Math.round(hourly.temperature_2m[i]);
                const code = hourly.weather_code[i];
                // approximate day/night for hourly (6 AM to 6 PM roughly for icons)
                const hour = new Date(hourly.time[i]).getHours();
                const isHourlyDay = hour >= 6 && hour <= 18;
                const hInfo = getWeatherInfo(code, isHourlyDay);

                hourlyContainer.innerHTML += `
                    <div class="flex flex-col items-center justify-between bg-white/10 rounded-2xl p-3 min-w-[70px] border border-white/10 shrink-0">
                        <span class="text-xs mb-2 opacity-80">${timeStr}</span>
                        <i data-lucide="${hInfo.icon}" class="w-6 h-6 mb-2"></i>
                        <span class="font-medium">${temp}°</span>
                    </div>
                `;
            }

            // 3. Update Daily Forecast
            const dailyContainer = document.getElementById('daily-container');
            dailyContainer.innerHTML = '';

            for (let i = 1; i < 7; i++) { // Skip today (index 0)
                if (!daily.time[i]) break;

                const dateObj = new Date(daily.time[i]);
                const dayName = dateObj.toLocaleDateString('he-IL', { weekday: 'long' });
                const maxT = Math.round(daily.temperature_2m_max[i]);
                const minT = Math.round(daily.temperature_2m_min[i]);
                const dInfo = getWeatherInfo(daily.weather_code[i], true); // Daily icons usually assume day

                dailyContainer.innerHTML += `
                    <div class="flex items-center justify-between py-2 border-b border-white/10 last:border-0">
                        <span class="w-24 font-medium">${dayName}</span>
                        <div class="flex items-center gap-2 flex-1 justify-center">
                            <i data-lucide="${dInfo.icon}" class="w-5 h-5 opacity-80"></i>
                            <span class="text-sm opacity-80 hidden sm:inline">${dInfo.desc}</span>
                        </div>
                        <div class="flex gap-4 w-24 justify-end">
                            <span class="font-medium">${maxT}°</span>
                            <span class="opacity-70">${minT}°</span>
                        </div>
                    </div>
                `;
            }

            // Re-render icons and show cards
            lucide.createIcons();
            
            elements.mainCard.classList.remove('hidden');
            elements.hourlyCard.classList.remove('hidden');
            elements.dailyCard.classList.remove('hidden');
            
            // Trigger reflow for animation
            void elements.mainCard.offsetWidth;
            
            elements.mainCard.classList.add('opacity-100');
            elements.hourlyCard.classList.add('opacity-100');
            elements.dailyCard.classList.add('opacity-100');
        }

        async function searchCity(query) {
            if (!query.trim()) return;
            toggleLoading(true);
            try {
                // Using Open-Meteo Geocoding API
                const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=he&format=json`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    // Fallback to English search if Hebrew fails
                    const urlEn = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en&format=json`;
                    const resEn = await fetch(urlEn);
                    const dataEn = await resEn.json();
                    
                    if (!dataEn.results || dataEn.results.length === 0) {
                        throw new Error("לא מצאנו עיר כזאת. נסה שוב.");
                    }
                    data.results = dataEn.results;
                }

                const city = data.results[0];
                const displayName = city.name + (city.country ? `, ${city.country}` : '');
                
                await fetchWeather(city.latitude, city.longitude, displayName);
                elements.input.value = ''; // Clear input
            } catch (err) {
                showMessage(err.message);
            } finally {
                toggleLoading(false);
            }
        }

        function getLocationWeather() {
            toggleLoading(true);
            if (!navigator.geolocation) {
                showMessage("הדפדפן שלך לא תומך באיתור מיקום");
                toggleLoading(false);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Reverse geocode to get city name (Using OpenStreetMap Nominatim for free)
                    try {
                        const geoUrl = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=he`;
                        const res = await fetch(geoUrl);
                        const geoData = await res.json();
                        
                        let cityName = 'המיקום שלי';
                        if (geoData.address) {
                            cityName = geoData.address.city || geoData.address.town || geoData.address.village || 'המיקום שלי';
                        }
                        
                        await fetchWeather(lat, lon, cityName);
                    } catch (e) {
                        // Fallback if reverse geocoding fails
                        await fetchWeather(lat, lon, "המיקום שלי");
                    } finally {
                        toggleLoading(false);
                    }
                },
                (error) => {
                    toggleLoading(false);
                    if (error.code === error.PERMISSION_DENIED) {
                        showMessage("אין הרשאת גישה למיקום. חפש לפי שם עיר.");
                    } else {
                        showMessage("לא הצלחנו לאתר את המיקום שלך.");
                    }
                }
            );
        }

        // --- Event Listeners & Initialization ---

        elements.form.addEventListener('submit', (e) => {
            e.preventDefault();
            searchCity(elements.input.value);
            elements.input.blur(); // dismiss keyboard on mobile
        });

        elements.locBtn.addEventListener('click', getLocationWeather);

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupPWA();
            
            // Initial load - try getting user location, otherwise fallback to Tel Aviv
            // Because geolocation prompts can be annoying immediately, we'll default to Tel Aviv 
            // and let the user click the location button if they want.
            fetchWeather(32.0853, 34.7818, "תל אביב-יפו");
        });

    </script>
</body>
</html>

